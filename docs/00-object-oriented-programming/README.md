# DataRaceDemo

## 概要

このプロジェクトは、オブジェクト指向プログラミングにおいて「**共有された参照**」と「**可変な状態**」が引き起こすデータ競合の問題を実証するためのC#テストプロジェクトです。

複数のスレッドが同じオブジェクトを共有し、その状態を同時に変更しようとする際、単一スレッド環境では想定されない結果が生じることを確認できます。このプロジェクトは、[../index.md](../index.md) の圏論学習ノートで説明されているオブジェクト指向の根本的な弱点を実装レベルで示しています。

## プロジェクト構成

### SharedMutableStateDataRaceTest.cs

#### `MutableCounter`クラス

**概要**：可変な状態を持つシンプルなカウンタークラスです。複数のスレッドから安全にアクセスできません。

**データ競合の原因**：
`Increment()` メソッドの実装では、C#の `Value++` という一見シンプルな操作が、実は以下の3つのステップに分解されます：
1. 現在の値をメモリから読み取る
2. 読んだ値に1を加える
3. 結果をメモリに書き込む

複数のスレッドが同時にこのメソッドを呼び出すと、これらのステップの間に別のスレッドが割り込み、読み取った古い値を基に計算・書き込みを行う可能性があります。その結果、複数のインクリメント操作が失われてしまいます。

#### `SharedMutableStateDataRaceTest`クラス

**テスト名**：`IncrementingSharedMutableState_CausesDataRace`

**テスト概要**：
- **準備 (Arrange)**：
  - ヒープ上に1つの `MutableCounter` インスタンスを作成
  - その参照を複数のタスク（スレッド）に共有する
  - 各タスクが100,000回インクリメントし、合計10タスク実行することで、期待値は1,000,000になるはず

- **実行 (Act)**：
  - 10個のタスクを並行実行
  - 各タスクは同じカウンターインスタンスに対して100,000回の `Increment()` を呼び出す
  - すべてのタスクが完了するまで待機

- **検証 (Assert)**：
  - データ競合が発生した場合、実際のカウンター値は期待値（1,000,000）よりも少なくなります
  - テストは、実際の値が期待値と**等しくないこと**を確認します
  - テスト出力には、期待値、実際の値、失われたカウント数が表示されます

## テストの実行方法

このプロジェクトには、データ競合を実証するための単体テストが含まれています。
プロジェクトのルートディレクトリで以下のコマンドを実行することで、テストを実行できます。

```bash
DataRaceDemo> dotnet test --logger "console;verbosity=detailed"
```

コマンドを実行すると、データ競合が原因でテストが失敗することが確認できます。
